<!DOCTYPE html>
<html lang="fi-FI">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="max-age=3600, must-revalidate">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#f0f2f5" />
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;200;400;600;800&display=swap" rel="stylesheet">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="manifest" href="site.webmanifest">
    <title>Pörssisähkön hintaennuste</title>
    <style>
        body {
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #666;
            margin: 20px;
            background-color: #f0f2f5;
            color: rgba(51, 51, 51, 0.9);
        }
        #predictionChart {
            height: 40vh;
            width: 100%;
            max-width: 920px;
            margin: auto;
            box-sizing: border-box;
            padding-top: 32px;
        }
        #chart {
            max-width: 920px;
            margin: auto;
            box-sizing: border-box;
        }

        #predictionText {
            max-width: 920px;
            line-height: 1.6;
            box-sizing: border-box;
            margin: auto;
            margin-top: 16px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            background-color: #fff;
            padding-left: 60px;
            padding-right: 60px;
            padding-top: 24px;
            padding-bottom: 24px;
        }        
        #narration {
            max-width: 920px;
            margin: auto;
            line-height: 1.6;
            padding-bottom: 24px;
            box-sizing: border-box;
        }
        #llm {
            max-width: 920px;
            margin: auto;
            text-align: left;
            color: rgba(102, 102, 102, 0.7);
            padding-top: 8px;
            line-height: 1.5;
            box-sizing: border-box;
            font-size: 0.9em;

        }
        #pastPredictions {
            height: 40vh;
            width: 100%;
            max-width: 920px;
            margin: auto;
            box-sizing: border-box;
            padding-bottom: 24px;
            padding-top: 24px;
        }
        #disclaimer {
            position: relative;
            max-width: 512px;
            line-height: 1.6;
            margin: 16px auto 0;
            color: #666;
            font-size: 0.8em;
            opacity: 0.6;
            width: 100%;
            padding: 4px 0;
            text-align: center;
        }
        #topdisclaimer {
            position: relative;
            max-width: 512px;
            line-height: 1.6;
            margin: auto;
            color: #666;
            font-size: 0.8em;
            opacity: 0.6;
            width: 100%;
            padding: 16px;
            padding-bottom: 8px;
            text-align: center;
        }
        #github-logo-container {
            text-align: center;
            width: 100%;
            left: 0;
            bottom: 0;
            padding: 0px 0;
            padding-top: 16px;
            margin: 16px 0 4px 0;
        }
        #source-code-text {
            color: #666;
            text-decoration: none;
            font-size: 0.8em;
            opacity: 0.5;
            transition: opacity 0.15s ease-in-out;
            text-align: center;
            margin-bottom: 32px;
        }

        #source-code-text:hover {
            color: #666;
            text-decoration: none;
            // font-size: 0.8em;
            opacity: 0.8;
        }

        #github-logo {
            height: 32px;
            opacity: 0.5;
            transition: opacity 0.15s ease-in-out;
        }

        #github-logo:hover {
            opacity: 0.8;
        }

        h1, h2, h3, h4, h5, h6 {
            font-weight: 200;
            color: rgba(102, 102, 102, 0.8);
            margin-bottom: 0;
            line-height: 1.3;
        }
        p {
            margin-bottom: 1em;
        }
        a {
            color: #000;
            text-decoration: underline;
            opacity: 0.6;
            border-bottom: 1px solid transparent;
            font-weight: 400;
            transition: opacity 0.15s ease-in-out;
        }
        a:source-code-link {
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
            color: #000;
            opacity: 1;
            font-weight: 500;
        }
        li {
            line-height: 1.6;
            margin-bottom: 8px;
            margin-left: 16px;
            padding-left: 16px;
            text-indent: -16px;
        }
        @media (max-width: 768px) {
            #body {
                margin: 4px;
            }
            #predictionText {
                padding-left: 20px;
                padding-right: 20px;
                padding-top: 16px;
            }
            #predictionChart {
                height: 60vh;
            }
            #pastPredictions {
                height: 60vh;
            }
            #disclaimer {
                max-width: 320px;
            }
            #topdisclaimer {
                max-width: 320px;
                padding: 8px;
                padding-bottom: 4px;
            }
        }        

    </style>
</head>
<body>
    <div id="topdisclaimer"><a href="privacy-policy.html">Mikä tämä on?</a></div>
    <div id="predictionText">
        <h1 style="padding-top: 16px">Pörssisähkön hintaennuste</h1>
        <p><strong>Tämä kokeellinen koneoppimismalli haarukoi pörssisähkön kuluttajahintaa noin 5 pv eteenpäin. Malli peilaa mm. ennustettua säätä, sähköntuotantoa ja nykyistä kuukautta/viikonpäivää aiempiin ajanjaksoihin, joissa nämä seikat olivat samankaltaiset.</strong></p>
        <p>Vaikka malli on toisinaan yllättävänkin tarkka, sen tuottamaan ennusteeseen tulee suhtautua varauksella. Se ei huomioi tulevia poikkeuspäiviä, kuten esim. ydinvoimaloiden tai siirtoyhteyksien huoltokatkoja. Sääennuste voi vielä muuttua, ja tämä vaikuttaa lähipäivien hintaan. Ennuste päivittyy muutaman kerran päivässä uusimman datan pohjalta.</p>
        <p>Nordpool-hinta näkyy liikennevalon väreillä. Mallin ennuste sinisellä katkoviivalla.</p>
        <p id="predictionChart"></p>
        <h1>Lähipäivien hintakehitys</h1>
        <p id="llm">Teksti on luotu koneellisesti kielimallin avulla.</p>
        <p id="narration"></p>
        <h1>Toteutunut hinta vs. ennuste</h1>
        <p>Graafi kertoo, miten pörssihinta ja hinta-arvio vertautuvat toisiinsa: "Mitä tämän sivun malli arvaisi sähkön hinnaksi näissä samoissa olosuhteissa?" Vie hiiri graafin päälle tai siirrä/tiivistä/laajenna aikajanaa, niin näet lisää.</p>
        <p id="pastPredictions"></p>
        <p>Tulevaisuudessa nämä samat olosuhteet saattavat johtaa erilaiseen hintaan, jolloin malli on ennusteineen väärässä.</p>
        <h1 style="padding-top: 32px">Mitä ennuste huomioi?</h1>
        <p>Kyseessä on <a href="https://statquest.org/statquest-random-forests-part-1-building-using-and-evaluating/" target="_blank">Random Forest</a> -koneoppimismalli, joka hakee korrelaatioita eri muuttujien välillä ja oppii, millaiseen hintaan kukin yhdistelmä historian perusteella johtaa. Tämä ei siis ole aikasarjaennuste, vaan jokainen tunti saa arvonsa erikseen näiden tietojen perusteella:</p>
        <li><strong>Isoimpien tuulivoima-alueiden tuuliennuste:</strong> FMI-sääasemat, eli epäsuorasti tuulivoiman määrä</li>
        <li><strong>Muutaman keskeisen asutuskeskuksen lämpötilaennuste:</strong> FMI-sääasemat, eli epäsuorasti lämmitystarve</li>
        <li><strong>Ydinvoimatuotanto:</strong> Fingrid, huomioidaan usemman tunnin viiveellä, eli huoltokatkot eivät näy mallille etukäteen</li>
        <li><strong>Viikonpäivä:</strong> ma-su</li>
        <li><strong>Kellonaika:</strong> 0-23</li>
        <li><strong>Kuukausi:</strong> vuodenajan vaikutus, jos sellainen vaikutus on</li>
        <p>Nämä muuttujat on valittu intuitiolla ja kokeilemalla. Jokin toinen yhdistelmä voisi toimia paremmin tai huonommin. Lähdekoodi on avointa, joten olet tervetullut kokeilemaan erilaisia vaihtoehtoja näiden lisäksi tai sijaan.<p>
        <p style="padding-bottom: 24px;">Ota huomioon, että sähkömarkkinoilla seilaa <a href="https://www.terracognita.fi/tuote/musta-joutsen/" target="_blank">mustia joutsenia</a> ja pörssisähkön ensi viikon hintaan ei tällä vatkaimella ole todellista näkyvyyttä, saati valtaa. Se lukee samoja sääennusteita kuin sinä, ja sääennusteet ovat tämän tästä väärässä. Vaikka malli osaa "ennustaa" menneisyyttä oivasti, se ei takaa että arviot tulevaisuudesta osuvat kohdalleen. Älä siis esim. säädä talosi lämmitystä näiden numeroiden perusteella, jos et ole kotona.</p>
        <div id="disclaimer" style="padding-bottom: 24px;"><a id="source-code-link" href="mailto:judo.farming0u@icloud.com" target="_blank">email</a></div>

    </div>
    </div>
    <div id="disclaimer">Lähteet: <a href="https://www.ilmatieteenlaitos.fi/havaintojen-lataus" target="_blank">Ilmatieteen laitos</a>, <a href="https://data.fingrid.fi" target="_blank">Fingrid</a>, <a href="https://sahkotin.fi/api" target="_blank">sahkotin.fi</a>.</div>
    <div id="github-logo-container"><a href="https://github.com/vividfog/nordpool-predict-fi" target="_blank"><img src="https://nordpool-predict-fi.web.app/github-mark.png" alt="GitHub Repo" id="github-logo"></a></div>
    <div id="source-code-text"><a id="source-code-link" href="https://github.com/vividfog/nordpool-predict-fi" target="_blank">vividfog/nordpool-predict-fi</a></div>

    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6065830160125618"
    crossorigin="anonymous"></script>
    <script>

        if (window.location.hostname === "nordpool-predict-fi.web.app") {
             window.location.href = "https://sahkovatkain.web.app" + window.location.pathname + window.location.search;
        }

        // Hosted on GitHub, Firebase Hosting, or locally?
        var baseUrl;

        switch (window.location.hostname) {
            case "":
                baseUrl = ".";
                break;
            case "nordpool-predict-fi.web.app":
                baseUrl = "https://nordpool-predict-fi.web.app";
                break;
            case "sahkovatkain.web.app":
                baseUrl = "https://sahkovatkain.web.app";
                break;
            default:
                baseUrl = "https://raw.githubusercontent.com/vividfog/nordpool-predict-fi/main/deploy";
        }


        //////////////////////////////////////////////////////////////////////////
        // Fetch the narration text from the Markdown file
        fetch(`${baseUrl}/narration.md`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.text();
        })
        .then(text => {
            // LLM generated text in quotes
            document.getElementById('narration').innerHTML = marked.parse("\"" + text + "\"");
        })
        .catch(error => console.error('Fetching Markdown failed:', error));  

        //////////////////////////////////////////////////////////////////////////
        // eCharts code for PREDICTION chart, including data from Sähkötin.fi
        var nfpChart = echarts.init(document.getElementById('predictionChart'));

        // Calculate start and end dates for Sähkötin
        var startDate = addDays(new Date(), -1).toISOString();
        var endDate = addDays(new Date(), 2).toISOString();
    
        // URLs for the datasets
        var npfUrl = `${baseUrl}/prediction.json`; // Using your existing baseUrl for NPF data
        var sahkotinUrl = 'https://sahkotin.fi/prices.csv';
        var sahkotinParams = new URLSearchParams({
            fix: 'true',
            vat: 'true',
            start: startDate,
            end: endDate,
        });

        // Helper function to calculate date ranges
        function addDays(date, days) {
            var result = new Date(date);
            result.setHours(0, 0, 0, 0);
            result.setDate(result.getDate() + days);
            return result;
        }
    
        // Fetch the data and display the chart
        Promise.all([
            fetch(npfUrl).then(r => r.json()), // Fetch NPF data
            fetch(`${sahkotinUrl}?${sahkotinParams}`).then(r => r.text()) // Fetch Sähkötin data
        ])
        .then(([npfData, sahkotinCsv]) => {
            // Prepare NPF series data
            var npfSeriesData = npfData.map(item => [item[0], item[1]]);
    
            // Prepare Sähkötin series data
            var sahkotinSeriesData = sahkotinCsv.split('\n').slice(1).map(line => {
                var [timestamp, price] = line.split(',');
                return [new Date(timestamp).getTime(), parseFloat(price)];
            });
    
            // Define the chart option with both series
            nfpChart.setOption({
                title: {
                    text: ' '
                },
                legend: {
                    data: ['Nordpool', 'Ennuste'],
                    right: 16
                },
                tooltip: {
                    trigger: 'axis',
                    formatter: function (params) {
                        var result = params[0].axisValueLabel + '<br/>';
                        params.forEach(function (item) {
                            // Round the value to one decimal place
                            var valueRounded = item.value[1].toFixed(1);
                            result += item.marker + " " + item.seriesName + ': ' + valueRounded + ' ¢/kWh<br/>';
                        });
                        return result;
                    }
                },
                xAxis: {
                    type: 'time',
                    boundaryGap: false,
                    axisLabel: {
                        formatter: function (value) {
                            var date = new Date(value);
                            var weekdays = ['su', 'ma', 'ti', 'ke', 'to', 'pe', 'la'];
                            var year = date.getFullYear();
                            var day = ("0" + date.getDate()).slice(-2);
                            var month = date.getMonth() + 1;  // add 1 since getMonth() starts from 0
                            var weekday = weekdays[date.getDay()];

                            return weekday + ' ' + day + '.';
                        }
                    }
                },
                yAxis: {
                    type: 'value',
                    name: '¢/kWh ALV24',
                    nameLocation: 'end',
                    nameGap: 20,
                    max: value => Math.ceil(value.max / 10) * 10, 
                    nameTextStyle: {
                        fontWeight: 'regular'
                    },
                    axisLabel: {
                        formatter: function (value) {
                            // Round the cents to one decimal place
                            return value.toFixed(0);
                        }
                    }
                },

                // Set gradient colors for the realized price
                visualMap: [{
                    show: false,
                    seriesIndex: [1],
                    top: 50,
                    right: 10,
                    pieces: [
                        {lte: 5, color: 'lime'},
                        {gt: 5, lte: 10, color: 'limegreen'},
                        {gt: 10, lte: 15, color: 'gold'},
                        {gt: 15, lte: 20, color: 'darkorange'},
                        {gt: 20, lte: 30, color: 'red'},
                        {gt: 30, color: 'darkred'}
                    ],
                    outOfRange: {
                        color: '#999'
                    }
                },
                
                // Set gradient colors for the predicted price
                {
                    show: false,
                    seriesIndex: [0],
                    top: 50,
                    right: 10,
                    pieces: [
                        {lte: 5, color: 'skyblue'},
                        {gt: 5, lte: 10, color: 'deepskyblue'},
                        {gt: 10, lte: 15, color: 'dodgerblue'},
                        {gt: 15, lte: 20, color: 'blue'},
                        {gt: 20, lte: 30, color: 'darkblue'},
                        {gt: 30, color: 'midnightblue'}
                    ],
                    outOfRange: {
                        color: '#999'
                    }
                }],

                // Data series
                series: [
                    {
                        // Prediction
                        name: 'Ennuste',
                        type: 'line',
                        data: npfSeriesData,
                        symbol: 'none',
                        lineStyle: {
                                    type: 'dotted',
                                    width: 3
                        },
                    }, 
                    {
                        // Realized
                        name: 'Nordpool',
                        type: 'line',
                        data: sahkotinSeriesData,
                        symbol: 'none',
                        step: 'middle',
                    }, 
                    {
                        // MarkLine for current time
                        type: 'line',
                        markLine: {
                            // Hides the symbol at the end of the line
                            symbol: 'none', 
                            label: {
                                formatter: function() {
                                    let currentTime = new Date();
                                    let hours = currentTime.getHours();
                                    let minutes = currentTime.getMinutes();

                                    hours = hours < 10 ? '0' + hours : hours;
                                    minutes = minutes < 10 ? '0' + minutes : minutes;
                                    // This will be local time 24 hour formatted string
                                    return 'klo ' + hours + ':' + minutes; 
                                },                                
                                position: 'end'
                            },
                            lineStyle: {
                                type: 'dotted',
                                color: 'skyblue',
                                width: 1.5
                            },
                            data: [
                                {
                                    // Current time as the position for the line
                                    xAxis: new Date().getTime()
                                }
                            ]
                        }
                    }
                ]  
            });

            // Match the time axis of the two series
            var npfSeriesData = npfData.map(item => [item[0] * 1000, item[1]]);

            var sahkotinSeriesData = sahkotinCsv.split('\n').slice(1).map(line => {
                var [timestamp, price] = line.split(',');
                return [new Date(timestamp).getTime(), parseFloat(price)];
            });
        })
        .catch(error => {
            console.error('Error fetching or processing data:', error);
        });

        // Function to update the vertical marker position
        function updateMarkerPosition() {
            console.log('A new minute, a new marker position!');
            var currentTime = new Date().getTime(); // Get current time in milliseconds

            // Update the markLine data for the current time marker
            var option = nfpChart.getOption(); // Get the current chart options to overwrite
            option.series.forEach((series) => {
                if (series.markLine) {
                    series.markLine.data = [
                        {
                            xAxis: currentTime
                        }
                    ];
                }
            });

            // Set the updated option to the chart without not merging
            nfpChart.setOption(option, false, false);
        }

        // Call the updateMarkerPosition function to update the marker
        setInterval(updateMarkerPosition, 3000); // 3000 milliseconds = check every 3 seconds

        // END: eCharts code predictions

        //////////////////////////////////////////////////////////////////////////
        // eCharts code for HISTORY chart
        var pastPredictions = echarts.init(document.getElementById('pastPredictions'));
    
        // Fetch the data and display the chart
        Promise.all([
            fetch(`${baseUrl}/past_performance.json`).then(r => r.json()) // Fetching past performance data
        ])
        .then(([jsonData]) => {
            var actualPriceData = jsonData.data.find(series => series.name === "Actual Price").data
                .map(item => [new Date(item[0]).getTime(), item[1]]);
            var predictedPriceData = jsonData.data.find(series => series.name === "Predicted Price").data
                .map(item => [new Date(item[0]).getTime(), item[1]]);

            pastPredictions.setOption({
                title: {
                    text: ' '
                },
                legend: {
                    data: ['Nordpool', 'Ennuste'],
                    right: 16
                },
                toolbox: {
                    // Not optimal on mobile, so disabled for now   
                    // feature: {
                    //     dataZoom: {
                    //         yAxisIndex: 'none'
                    //     },
                    //     restore: {},
                    //     saveAsImage: {}
                    // }
                },
                dataZoom: [
                    // {
                    //     type: 'inside',
                    //     start: 66,
                    //     end: 100
                    // },
                    {
                        type: 'slider',
                        start: 66,
                        end: 100
                    }
                ],
                tooltip: {
                    trigger: 'axis',
                    formatter: function (params) {
                        var result = params[0].axisValueLabel + '<br/>';
                        params.forEach(function (item) {
                            var valueRounded = item.value[1].toFixed(1);
                            result += item.marker + " " + item.seriesName + ': ' + valueRounded + ' ¢/kWh<br/>';
                        });
                        return result;
                    }
                },
                xAxis: {
                    type: 'time',
                    boundaryGap: false,
                    axisLabel: {
                        formatter: function (value) {
                            var date = new Date(value);
                            return date.toLocaleDateString('fi-FI');
                        },
                        rotate: 45,

                    }
                },
                yAxis: {
                    type: 'value',
                    name: '¢/kWh ALV24',
                    nameLocation: 'end',
                    nameGap: 20,
                    axisLabel: {
                        formatter: '{value}'
                    }
                },
                series: [
                    {
                        name: 'Nordpool',
                        type: 'line',
                        data: actualPriceData,
                        symbol: 'none',
                        symbolSize: 6,
                        smooth: true,
                        lineStyle: {
                            color: 'skyblue',
                            width: 1
                        },
                        itemStyle: { 
                            color: 'skyblue'
                        }
                    },
                    {
                        name: 'Ennuste',
                        type: 'line',
                        data: predictedPriceData,
                        symbol: 'none',
                        symbolSize: 6,
                        smooth: true,
                        lineStyle: {
                            color: 'darkorange',
                            width: 1
                        },
                        itemStyle: {
                            color: 'darkorange'
                        },

                    }
                ]
            });
        })
        .catch(error => {
            console.error('Error fetching or processing data:', error);
        });
        // END: eCharts code for history

        // Resize the chart when the window is resized
        window.onresize = function() {
            nfpChart.resize();
            pastPredictions.resize();
        }
        </script>
        <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6065830160125618" crossorigin="anonymous"></script>
    </body>
</html>
